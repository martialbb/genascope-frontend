// Refactored Chat Configuration Manager - now using modular component architecture
// This replaces the original 2189-line monolithic component

import React from 'react';
import { ChatConfigurationManager } from './chat/ChatConfigurationManager';

const ChatConfigurationManagerNewWorkingSimple: React.FC = () => {
  return <ChatConfigurationManager />;
};

export default ChatConfigurationManagerNewWorkingSimple;
  // Common button styles
  const buttonStyles = {
    primary: "px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-semibold rounded-xl hover:from-blue-700 hover:to-blue-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 flex items-center space-x-2 shadow-lg",
    secondary: "px-6 py-3 border-2 border-gray-300 rounded-xl text-gray-700 font-semibold hover:bg-gray-50 hover:border-gray-400 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 flex items-center space-x-2",
    small: "px-3 py-2 text-sm font-medium rounded-md transition-all duration-200",
    pagination: "px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
  };

  const [activeView, setActiveView] = useState<'dashboard' | 'wizard' | 'analytics'>('dashboard');
  const [strategies, setStrategies] = useState<ChatStrategy[]>([]);
  const [knowledgeSources, setKnowledgeSources] = useState<KnowledgeSource[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [currentStep, setCurrentStep] = useState<ConfigurationStep>('overview');
  const [editingStrategy, setEditingStrategy] = useState<ChatStrategy | null>(null);
  const [strategyForm, setStrategyForm] = useState<StrategyFormData>({
    name: '',
    description: '',
    goal: '',
    patient_introduction: '',
    specialty: 'Oncology',
    is_active: false,
    targeting_rules: [],
    knowledge_source_ids: [],
    outcome_actions: []
  });
  const [newTargetingRule, setNewTargetingRule] = useState<TargetingRuleForm>({
    name: '',
    field: '',
    operator: 'equals',
    value: '',
    sequence: 0
  });
  const [uploadedFiles, setUploadedFiles] = useState<File[]>([]);
  const [dragActive, setDragActive] = useState(false);
  const [uploadProgress, setUploadProgress] = useState<Record<string, number>>({});
  const fileInputRef = useRef<HTMLInputElement>(null);
  
  // Testing and deployment state
  const [testResults, setTestResults] = useState<any>(null);
  const [isTestingStrategy, setIsTestingStrategy] = useState(false);
  const [isDeploying, setIsDeploying] = useState(false);
  const [testScenarios, setTestScenarios] = useState([
    { id: 1, name: 'New Patient Onboarding', status: 'pending' },
    { id: 2, name: 'Follow-up Appointment', status: 'pending' },
    { id: 3, name: 'Symptom Assessment', status: 'pending' }
  ]);

  // Filtering and pagination state
  const [searchTerm, setSearchTerm] = useState('');
  const [statusFilter, setStatusFilter] = useState<'all' | 'active' | 'draft'>('all');
  const [specialtyFilter, setSpecialtyFilter] = useState<string>('all');
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage] = useState(6); // 6 cards per page for nice grid layout

  const loadStrategies = async () => {
    try {
      setLoading(true);
      const response = await chatConfigurationAPI.getStrategies({ skip: 0, limit: 100 });
      setStrategies(response.strategies || []);
    } catch (error) {
      console.error('Error loading strategies:', error);
      setError('Failed to load strategies');
    } finally {
      setLoading(false);
    }
  };

  // Load data on component mount
  useEffect(() => {
    if (activeView === 'dashboard') {
      loadStrategies();
    }
    loadKnowledgeSources();
  }, [activeView]);

  const loadKnowledgeSources = async () => {
    try {
      const knowledgeSources = await chatConfigurationAPI.getKnowledgeSources();
      setKnowledgeSources(knowledgeSources);
    } catch (error) {
      console.error('Error loading knowledge sources:', error);
    }
  };

  const handleSaveStrategy = async () => {
    try {
      setLoading(true);
      setError(null);
      
      const strategyData: ChatStrategyCreate = {
        name: strategyForm.name,
        description: strategyForm.description,
        goal: strategyForm.goal,
        patient_introduction: strategyForm.patient_introduction,
        specialty: strategyForm.specialty,
        knowledge_source_ids: strategyForm.knowledge_source_ids,
        targeting_rules: strategyForm.targeting_rules.map(rule => ({
          field: rule.field,
          operator: rule.operator,
          value: rule.value,
          sequence: rule.sequence
        })),
        outcome_actions: strategyForm.outcome_actions.map(action => ({
          condition: action.condition || '',
          action_type: action.action_type,
          details: action.details || {},
          sequence: action.sequence
        }))
      };

      if (editingStrategy?.id) {
        // Update existing strategy
        await chatConfigurationAPI.updateStrategy(editingStrategy.id, {
          name: strategyData.name,
          description: strategyData.description,
          goal: strategyData.goal,
          is_active: strategyForm.is_active
        });
        
        // Note: For a complete implementation, you might need additional API endpoints
        // to update targeting rules, knowledge sources, and outcome actions separately
      } else {
        // Create new strategy
        await chatConfigurationAPI.createStrategy(strategyData);
      }
      
      // Reset form and editing state, go back to dashboard
      setStrategyForm({
        name: '',
        description: '',
        goal: '',
        patient_introduction: '',
        specialty: 'Oncology',
        is_active: false,
        targeting_rules: [],
        knowledge_source_ids: [],
        outcome_actions: []
      });
      setEditingStrategy(null);
      setCurrentStep('overview');
      setActiveView('dashboard');
      loadStrategies();
      
    } catch (error) {
      console.error('Error saving strategy:', error);
      setError('Failed to save strategy');
    } finally {
      setLoading(false);
    }
  };

  const handleDeleteStrategy = async (id: string) => {
    if (!confirm('Are you sure you want to delete this strategy?')) return;
    
    try {
      await chatConfigurationAPI.deleteStrategy(id);
      loadStrategies();
    } catch (error) {
      console.error('Error deleting strategy:', error);
      setError('Failed to delete strategy');
    }
  };

  const handleToggleStrategy = async (id: string, currentStatus: boolean) => {
    try {
      await chatConfigurationAPI.updateStrategy(id, { is_active: !currentStatus });
      // Update the strategy in local state immediately for better UX
      setStrategies(prev => prev.map(strategy => 
        strategy.id === id 
          ? { ...strategy, is_active: !currentStatus }
          : strategy
      ));
    } catch (error) {
      console.error('Error toggling strategy:', error);
      setError('Failed to update strategy status');
      // Optionally reload strategies to ensure consistency
      loadStrategies();
    }
  };

  const handleEditStrategy = (strategy: ChatStrategy) => {
    // Populate the form with existing strategy data
    setStrategyForm({
      name: strategy.name || '',
      description: strategy.description || '',
      goal: strategy.goal || '',
      patient_introduction: strategy.patient_introduction || '',
      specialty: strategy.specialty || 'Oncology',
      is_active: strategy.is_active || false,
      targeting_rules: strategy.targeting_rules || [],
      knowledge_source_ids: strategy.knowledge_sources?.map(ks => ks.id!).filter(Boolean) || [],
      outcome_actions: strategy.outcome_actions || []
    });
    
    // Set editing state
    setEditingStrategy(strategy);
    
    // Reset wizard state
    setCurrentStep('overview');
    setTestResults(null);
    setTestScenarios([
      { id: 1, name: 'New Patient Onboarding', status: 'pending' },
      { id: 2, name: 'Follow-up Appointment', status: 'pending' },
      { id: 3, name: 'Symptom Assessment', status: 'pending' }
    ]);
    
    // Switch to wizard view
    setActiveView('wizard');
  };

  const handleCreateNewStrategy = () => {
    // Reset form to defaults
    setStrategyForm({
      name: '',
      description: '',
      goal: '',
      patient_introduction: '',
      specialty: 'Oncology',
      is_active: false,
      targeting_rules: [],
      knowledge_source_ids: [],
      outcome_actions: []
    });
    
    // Clear editing state
    setEditingStrategy(null);
    
    // Reset wizard state
    setCurrentStep('overview');
    setTestResults(null);
    setTestScenarios([
      { id: 1, name: 'New Patient Onboarding', status: 'pending' },
      { id: 2, name: 'Follow-up Appointment', status: 'pending' },
      { id: 3, name: 'Symptom Assessment', status: 'pending' }
    ]);
    
    // Switch to wizard view
    setActiveView('wizard');
  };

  const handleFileUpload = async (files: FileList | null) => {
    if (!files) return;
    
    try {
      setLoading(true);
      const uploadPromises = Array.from(files).map(async (file) => {
        const formData = new FormData();
        formData.append('file', file);
        return await chatConfigurationAPI.uploadFile({
          file,
          name: file.name,
          description: `Uploaded via dashboard: ${file.name}`
        });
      });
      
      const uploadedSources = await Promise.all(uploadPromises);
      
      // Add uploaded knowledge sources to form
      const newIds = uploadedSources.map((source: any) => source.id).filter(Boolean);
      setStrategyForm(prev => ({
        ...prev,
        knowledge_source_ids: [...prev.knowledge_source_ids, ...newIds]
      }));
      
      loadKnowledgeSources();
    } catch (error) {
      console.error('Error uploading files:', error);
      setError('Failed to upload files');
    } finally {
      setLoading(false);
    }
  };

  // Form validation functions
  const isStepComplete = (step: ConfigurationStep): boolean => {
    switch (step) {
      case 'overview':
        return !!(strategyForm.name && strategyForm.description && strategyForm.goal && strategyForm.patient_introduction);
      case 'targeting':
        return strategyForm.targeting_rules.length > 0;
      case 'knowledge':
        return strategyForm.knowledge_source_ids.length > 0;
      case 'outcomes':
        return strategyForm.outcome_actions.length > 0;
      case 'testing':
        return testResults?.status === 'passed' || testResults?.status === 'completed';
      case 'review':
        // Review step is complete only when all required previous steps are complete
        return !!(strategyForm.name && strategyForm.description && strategyForm.goal && strategyForm.patient_introduction) &&
               strategyForm.targeting_rules.length > 0 &&
               strategyForm.knowledge_source_ids.length > 0 &&
               strategyForm.outcome_actions.length > 0 &&
               (testResults?.status === 'passed' || testResults?.status === 'completed');
      default:
        return false;
    }
  };

  const canNavigateToStep = (targetStep: ConfigurationStep): boolean => {
    const currentIndex = steps.findIndex(s => s.id === currentStep);
    const targetIndex = steps.findIndex(s => s.id === targetStep);
    
    // Can always go backwards
    if (targetIndex <= currentIndex) return true;
    
    // Check if all previous steps are complete
    for (let i = 0; i < targetIndex; i++) {
      if (!isStepComplete(steps[i].id as ConfigurationStep)) {
        return false;
      }
    }
    return true;
  };

  // Testing functions
  const handleRunTests = async () => {
    setIsTestingStrategy(true);
    try {
      // Simulate running test scenarios
      for (let i = 0; i < testScenarios.length; i++) {
        // Update scenario status to running
        setTestScenarios(prev => prev.map(scenario => 
          scenario.id === testScenarios[i].id 
            ? { ...scenario, status: 'running' }
            : scenario
        ));
        
        // Simulate test execution delay
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Update scenario status to passed
        setTestScenarios(prev => prev.map(scenario => 
          scenario.id === testScenarios[i].id 
            ? { ...scenario, status: 'passed' }
            : scenario
        ));
      }
      
      setTestResults({
        status: 'passed',
        completedAt: new Date(),
        totalScenarios: testScenarios.length,
        passedScenarios: testScenarios.length
      });
    } catch (error) {
      console.error('Error running tests:', error);
      setTestResults({
        status: 'failed',
        completedAt: new Date(),
        error: 'Test execution failed'
      });
    } finally {
      setIsTestingStrategy(false);
    }
  };

  // Deployment function
  const handleDeployStrategy = async () => {
    if (!isStepComplete('overview') || !isStepComplete('targeting') || !isStepComplete('knowledge') || !isStepComplete('outcomes')) {
      setError('Please complete all required steps before deploying');
      return;
    }

    setIsDeploying(true);
    try {
      await handleSaveStrategy();
      // Additional deployment logic could go here
      alert('Strategy deployed successfully!');
      setActiveView('dashboard');
    } catch (error) {
      console.error('Error deploying strategy:', error);
      setError('Failed to deploy strategy');
    } finally {
      setIsDeploying(false);
    }
  };

  // Filtering and pagination logic
  const filteredStrategies = strategies.filter(strategy => {
    const matchesSearch = !searchTerm || 
      strategy.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      strategy.description?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      strategy.specialty?.toLowerCase().includes(searchTerm.toLowerCase());
    
    const matchesStatus = statusFilter === 'all' || 
      (statusFilter === 'active' && strategy.is_active) ||
      (statusFilter === 'draft' && !strategy.is_active);
    
    const matchesSpecialty = specialtyFilter === 'all' || 
      strategy.specialty === specialtyFilter;
    
    return matchesSearch && matchesStatus && matchesSpecialty;
  });

  const totalPages = Math.ceil(filteredStrategies.length / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const paginatedStrategies = filteredStrategies.slice(startIndex, startIndex + itemsPerPage);

  // Get unique specialties for filter dropdown
  const uniqueSpecialties = [...new Set(strategies.map(s => s.specialty).filter(Boolean))];

  // Reset page when filters change
  useEffect(() => {
    setCurrentPage(1);
  }, [searchTerm, statusFilter, specialtyFilter]);

  const steps = [
    { id: 'overview', name: 'Overview', description: 'Basic strategy information' },
    { id: 'targeting', name: 'Targeting', description: 'Patient targeting rules' },
    { id: 'knowledge', name: 'Knowledge', description: 'Knowledge sources' },
    { id: 'outcomes', name: 'Outcomes', description: 'Outcome actions' },
    { id: 'testing', name: 'Testing', description: 'Test configuration' },
    { id: 'review', name: 'Review', description: 'Review and deploy' }
  ];

  const handleFormChange = (field: keyof StrategyFormData, value: any) => {
    setStrategyForm(prev => ({
      ...prev,
      [field]: value
    }));
  };

  const renderOverviewStep = () => (
    <div className="space-y-8">
      <div className="text-center">
        <div className="mx-auto w-16 h-16 bg-gradient-to-r from-blue-100 to-blue-200 rounded-full flex items-center justify-center mb-4">
          <svg className="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
        <h3 className="text-2xl font-bold text-gray-900 mb-2">Strategy Overview</h3>
        <p className="text-gray-600 text-lg">Define the basic information for your chat strategy.</p>
      </div>
      
      <div className="grid grid-cols-1 gap-8 max-w-4xl mx-auto">
        <div className="bg-gradient-to-r from-gray-50 to-gray-100 p-6 rounded-xl">
          <label className="block text-sm font-bold text-gray-800 mb-3 flex items-center">
            <svg className="w-4 h-4 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a.997.997 0 01-1.414 0l-7-7A2 2 0 013 12V7a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            Strategy Name
          </label>
          <input
            type="text"
            value={strategyForm.name}
            onChange={(e) => handleFormChange('name', e.target.value)}
            className="w-full border-2 border-gray-300 rounded-xl px-4 py-3 text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
            placeholder="e.g., Breast Cancer Screening Protocol"
          />
        </div>
        
        <div className="bg-gradient-to-r from-gray-50 to-gray-100 p-6 rounded-xl">
          <label className="block text-sm font-bold text-gray-800 mb-3 flex items-center">
            <svg className="w-4 h-4 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h7" />
            </svg>
            Description
          </label>
          <textarea
            value={strategyForm.description}
            onChange={(e) => handleFormChange('description', e.target.value)}
            rows={4}
            className="w-full border-2 border-gray-300 rounded-xl px-4 py-3 text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
            placeholder="Describe the purpose and scope of this strategy..."
          />
        </div>
        
        <div className="bg-gradient-to-r from-gray-50 to-gray-100 p-6 rounded-xl">
          <label className="block text-sm font-bold text-gray-800 mb-3 flex items-center">
            <svg className="w-4 h-4 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            Primary Goal
          </label>
          <textarea
            value={strategyForm.goal}
            onChange={(e) => handleFormChange('goal', e.target.value)}
            rows={3}
            className="w-full border-2 border-gray-300 rounded-xl px-4 py-3 text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
            placeholder="What should this strategy accomplish?"
          />
        </div>
        
        <div className="bg-gradient-to-r from-gray-50 to-gray-100 p-6 rounded-xl">
          <label className="block text-sm font-bold text-gray-800 mb-3 flex items-center">
            <svg className="w-4 h-4 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" />
            </svg>
            Patient Introduction
          </label>
          <textarea
            value={strategyForm.patient_introduction}
            onChange={(e) => handleFormChange('patient_introduction', e.target.value)}
            rows={4}
            className="w-full border-2 border-gray-300 rounded-xl px-4 py-3 text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
            placeholder="How should the AI introduce itself to patients?"
          />
        </div>
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div className="bg-gradient-to-r from-gray-50 to-gray-100 p-6 rounded-xl">
            <label className="block text-sm font-bold text-gray-800 mb-3 flex items-center">
              <svg className="w-4 h-4 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
              </svg>
              Specialty
            </label>
            <select
              value={strategyForm.specialty}
              onChange={(e) => handleFormChange('specialty', e.target.value)}
              className="w-full border-2 border-gray-300 rounded-xl px-4 py-3 text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
            >
              <option value="Oncology">Oncology</option>
              <option value="Cardiology">Cardiology</option>
              <option value="Dermatology">Dermatology</option>
              <option value="Gastroenterology">Gastroenterology</option>
              <option value="Neurology">Neurology</option>
              <option value="Orthopedics">Orthopedics</option>
            </select>
          </div>
          
          <div className="bg-gradient-to-r from-green-50 to-green-100 p-6 rounded-xl">
            <label className="block text-sm font-bold text-gray-800 mb-3 flex items-center">
              <svg className="w-4 h-4 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
              Activation
            </label>
            <div className="flex items-center bg-white p-4 rounded-lg border-2 border-green-200">
              <input
                type="checkbox"
                id="is_active"
                checked={strategyForm.is_active}
                onChange={(e) => handleFormChange('is_active', e.target.checked)}
                className="h-5 w-5 text-green-600 focus:ring-green-500 border-gray-300 rounded"
              />
              <label htmlFor="is_active" className="ml-3 block text-sm font-medium text-gray-900">
                Activate strategy immediately after creation
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>
  );

  const renderTargetingStep = () => {
    const targetingFieldOptions = [
      { value: 'age', label: 'Age' },
      { value: 'gender', label: 'Gender' },
      { value: 'diagnosis', label: 'Primary Diagnosis' },
      { value: 'family_history', label: 'Family History' },
      { value: 'risk_factors', label: 'Risk Factors' },
      { value: 'previous_screening', label: 'Previous Screening' },
      { value: 'medications', label: 'Current Medications' },
      { value: 'symptoms', label: 'Current Symptoms' },
      { value: 'location', label: 'Geographic Location' },
      { value: 'insurance', label: 'Insurance Coverage' }
    ];

    const operatorOptions = [
      { value: 'equals', label: 'Equals' },
      { value: 'not_equals', label: 'Does not equal' },
      { value: 'contains', label: 'Contains' },
      { value: 'not_contains', label: 'Does not contain' },
      { value: 'greater_than', label: 'Greater than' },
      { value: 'less_than', label: 'Less than' },
      { value: 'between', label: 'Between' },
      { value: 'in_list', label: 'In list' },
      { value: 'not_in_list', label: 'Not in list' }
    ];

    const addTargetingRule = () => {
      const newRule: TargetingRule = {
        field: 'age',
        operator: 'greater_than',
        value: '',
        sequence: strategyForm.targeting_rules.length + 1
      };
      
      setStrategyForm(prev => ({
        ...prev,
        targeting_rules: [...prev.targeting_rules, newRule]
      }));
    };

    const updateTargetingRule = (index: number, field: keyof TargetingRule, value: any) => {
      setStrategyForm(prev => ({
        ...prev,
        targeting_rules: prev.targeting_rules.map((rule, i) => 
          i === index ? { ...rule, [field]: value } : rule
        )
      }));
    };

    const removeTargetingRule = (index: number) => {
      setStrategyForm(prev => ({
        ...prev,
        targeting_rules: prev.targeting_rules.filter((_, i) => i !== index)
      }));
    };

    return (
      <div className="space-y-8">
        <div className="text-center">
          <div className="mx-auto w-16 h-16 bg-gradient-to-r from-purple-100 to-purple-200 rounded-full flex items-center justify-center mb-4">
            <svg className="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z" />
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6 2.69-6 6-6z" />
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c2.21 0 4 1.79 4 4s-1.79 4-4 4-4-1.79-4-4 1.79-4 4-4z" />
              <circle cx="12" cy="12" r="2" fill="currentColor" />
            </svg>
          </div>
          <h3 className="text-2xl font-bold text-gray-900 mb-2">Patient Targeting Rules</h3>
          <p className="text-gray-600 text-lg">Define which patients should receive this strategy based on their profile and medical history.</p>
        </div>

        <div className="max-w-4xl mx-auto">
          <div className="bg-gradient-to-r from-purple-50 to-purple-100 p-6 rounded-xl border-2 border-purple-200 mb-6">
            <h4 className="text-lg font-semibold text-purple-800 mb-3">Targeting Rules</h4>
            <p className="text-purple-600 mb-4">Add rules to specify which patients this strategy should target. All rules must be satisfied for a patient to be eligible.</p>
            
            {strategyForm.targeting_rules.length === 0 ? (
              <div className="text-center py-8">
                <svg className="w-12 h-12 text-purple-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4" />
                </svg>
                <p className="text-purple-500 mb-4">No targeting rules defined yet</p>
                <button
                  onClick={addTargetingRule}
                  className="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors"
                >
                  Add First Rule
                </button>
              </div>
            ) : (
              <div className="space-y-4">
                {strategyForm.targeting_rules.map((rule, index) => (
                  <div key={index} className="bg-white p-4 rounded-lg border-2 border-purple-200">
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Field</label>
                        <select
                          value={rule.field}
                          onChange={(e) => updateTargetingRule(index, 'field', e.target.value)}
                          className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                        >
                          {targetingFieldOptions.map(option => (
                            <option key={option.value} value={option.value}>{option.label}</option>
                          ))}
                        </select>
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Operator</label>
                        <select
                          value={rule.operator}
                          onChange={(e) => updateTargetingRule(index, 'operator', e.target.value)}
                          className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                        >
                          {operatorOptions.map(option => (
                            <option key={option.value} value={option.value}>{option.label}</option>
                          ))}
                        </select>
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Value</label>
                        <input
                          type="text"
                          value={typeof rule.value === 'string' ? rule.value : JSON.stringify(rule.value)}
                          onChange={(e) => updateTargetingRule(index, 'value', e.target.value)}
                          className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                          placeholder="Enter value..."
                        />
                      </div>
                      
                      <div className="flex items-end">
                        <button
                          onClick={() => removeTargetingRule(index)}
                          className="w-full bg-red-100 text-red-600 px-3 py-2 rounded-md hover:bg-red-200 transition-colors"
                        >
                          Remove
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
                
                <button
                  onClick={addTargetingRule}
                  className="w-full bg-purple-100 text-purple-600 px-4 py-3 rounded-lg border-2 border-purple-200 hover:bg-purple-200 transition-colors flex items-center justify-center"
                >
                  <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                  </svg>
                  Add Another Rule
                </button>
              </div>
            )}
          </div>

          <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
            <h5 className="font-semibold text-blue-800 mb-2">Example Targeting Rules:</h5>
            <ul className="text-sm text-blue-700 space-y-1">
              <li>â€¢ Age greater than 40 (for screening eligibility)</li>
              <li>â€¢ Family history contains "breast cancer" (for high-risk patients)</li>
              <li>â€¢ Previous screening equals "overdue" (for follow-up reminders)</li>
              <li>â€¢ Risk factors in list ["BRCA1", "BRCA2"] (for genetic counseling)</li>
            </ul>
          </div>
        </div>
      </div>
    );
  };

  const renderKnowledgeStep = () => {
    const handleDrag = (e: React.DragEvent) => {
      e.preventDefault();
      e.stopPropagation();
      if (e.type === "dragenter" || e.type === "dragover") {
        setDragActive(true);
      } else if (e.type === "dragleave") {
        setDragActive(false);
      }
    };

    const handleDrop = (e: React.DragEvent) => {
      e.preventDefault();
      e.stopPropagation();
      setDragActive(false);
      
      if (e.dataTransfer.files && e.dataTransfer.files[0]) {
        handleFiles(Array.from(e.dataTransfer.files));
      }
    };

    const handleFileInput = (e: React.ChangeEvent<HTMLInputElement>) => {
      if (e.target.files) {
        handleFiles(Array.from(e.target.files));
      }
    };

    const handleFiles = async (files: File[]) => {
      const validFiles = files.filter(file => {
        const validTypes = [
          'application/pdf',
          'text/plain',
          'application/msword',
          'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
          'text/csv',
          'application/json'
        ];
        return validTypes.includes(file.type) && file.size <= 10 * 1024 * 1024; // 10MB limit
      });

      if (validFiles.length !== files.length) {
        setError('Some files were skipped. Only PDF, DOC, DOCX, TXT, CSV, and JSON files under 10MB are supported.');
      }

      for (const file of validFiles) {
        setUploadProgress(prev => ({ ...prev, [file.name]: 0 }));
        
        try {
          // Simulate upload progress
          const progressInterval = setInterval(() => {
            setUploadProgress(prev => {
              const current = prev[file.name] || 0;
              if (current >= 90) {
                clearInterval(progressInterval);
                return prev;
              }
              return { ...prev, [file.name]: current + 10 };
            });
          }, 200);

          const response = await chatConfigurationAPI.uploadFile({
            file,
            name: file.name,
            description: `Uploaded via dashboard: ${file.name}`
          });

          clearInterval(progressInterval);
          setUploadProgress(prev => ({ ...prev, [file.name]: 100 }));

          // Add to knowledge sources list and strategy form
          setKnowledgeSources(prev => [...prev, response as any]);
          setStrategyForm(prev => ({
            ...prev,
            knowledge_source_ids: [...prev.knowledge_source_ids, response.id]
          }));

          setTimeout(() => {
            setUploadProgress(prev => {
              const newPrev = { ...prev };
              delete newPrev[file.name];
              return newPrev;
            });
          }, 2000);

        } catch (error) {
          console.error('Upload failed:', error);
          setUploadProgress(prev => {
            const newPrev = { ...prev };
            delete newPrev[file.name];
            return newPrev;
          });
          setError(`Failed to upload ${file.name}`);
        }
      }
    };

    const removeKnowledgeSource = (sourceId: string) => {
      setStrategyForm(prev => ({
        ...prev,
        knowledge_source_ids: prev.knowledge_source_ids.filter(id => id !== sourceId)
      }));
    };

    const selectedSources = knowledgeSources.filter(source => 
      strategyForm.knowledge_source_ids.includes(source.id || '')
    );

    return (
      <div className="space-y-8">
        <div className="text-center">
          <div className="mx-auto w-16 h-16 bg-gradient-to-r from-green-100 to-green-200 rounded-full flex items-center justify-center mb-4">
            <svg className="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />
            </svg>
          </div>
          <h3 className="text-2xl font-bold text-gray-900 mb-2">Knowledge Sources</h3>
          <p className="text-gray-600 text-lg">Upload and manage knowledge sources that will guide the AI's responses and decision-making.</p>
        </div>

        <div className="max-w-4xl mx-auto">
          {/* File Upload Area */}
          <div className="bg-gradient-to-r from-green-50 to-green-100 p-6 rounded-xl border-2 border-green-200 mb-6">
            <h4 className="text-lg font-semibold text-green-800 mb-4">Upload Knowledge Files</h4>
            
            <div
              className={`border-2 border-dashed rounded-xl p-8 text-center transition-all duration-200 ${
                dragActive
                  ? 'border-green-400 bg-green-50'
                  : 'border-green-300 hover:border-green-400 hover:bg-green-50'
              }`}
              onDragEnter={handleDrag}
              onDragLeave={handleDrag}
              onDragOver={handleDrag}
              onDrop={handleDrop}
            >
              <svg className="w-12 h-12 text-green-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
              </svg>
              <h5 className="text-lg font-semibold text-green-800 mb-2">
                {dragActive ? 'Drop files here' : 'Drag & drop files here'}
              </h5>
              <p className="text-green-600 mb-4">
                or <button
                  onClick={() => fileInputRef.current?.click()}
                  className="text-green-700 font-semibold hover:underline"
                >
                  browse files
                </button>
              </p>
              <p className="text-sm text-green-500">
                Supports PDF, DOC, DOCX, TXT, CSV, JSON files up to 10MB
              </p>
              <input
                ref={fileInputRef}
                type="file"
                multiple
                onChange={handleFileInput}
                accept=".pdf,.doc,.docx,.txt,.csv,.json"
                className="hidden"
              />
            </div>

            {/* Upload Progress */}
            {Object.keys(uploadProgress).length > 0 && (
              <div className="mt-4 space-y-2">
                {Object.entries(uploadProgress).map(([fileName, progress]) => (
                  <div key={fileName} className="bg-white p-3 rounded-lg border border-green-200">
                    <div className="flex justify-between items-center mb-1">
                      <span className="text-sm font-medium text-gray-700">{fileName}</span>
                      <span className="text-sm text-green-600">{progress}%</span>
                    </div>
                    <div className="w-full bg-green-100 rounded-full h-2">
                      <div
                        className="bg-green-500 h-2 rounded-full transition-all duration-300"
                        style={{ width: `${progress}%` }}
                      ></div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Selected Knowledge Sources */}
          <div className="bg-white border-2 border-green-200 rounded-xl p-6">
            <h4 className="text-lg font-semibold text-green-800 mb-4">Selected Knowledge Sources ({selectedSources.length})</h4>
            
            {selectedSources.length === 0 ? (
              <div className="text-center py-8">
                <svg className="w-12 h-12 text-green-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <p className="text-green-500 mb-2">No knowledge sources selected</p>
                <p className="text-sm text-green-400">Upload files or select from existing sources to get started</p>
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {selectedSources.map((source) => (
                  <div key={source.id} className="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div className="flex justify-between items-start">
                      <div className="flex-1">
                        <h5 className="font-semibold text-green-800">{source.name}</h5>
                        <p className="text-sm text-green-600 mt-1">{source.description || 'No description'}</p>
                        <div className="flex items-center mt-2 text-xs text-green-500">
                          <span className="capitalize">{source.source_type || 'file'}</span>
                          {source.file_size && (
                            <span className="ml-2">
                              {(source.file_size / 1024 / 1024).toFixed(1)} MB
                            </span>
                          )}
                        </div>
                      </div>
                      <button
                        onClick={() => removeKnowledgeSource(source.id || '')}
                        className="ml-3 text-red-500 hover:text-red-700 transition-colors"
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Existing Knowledge Sources */}
          {knowledgeSources.length > selectedSources.length && (
            <div className="bg-gray-50 border-2 border-gray-200 rounded-xl p-6">
              <h4 className="text-lg font-semibold text-gray-800 mb-4">Available Knowledge Sources</h4>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {knowledgeSources
                  .filter(source => !strategyForm.knowledge_source_ids.includes(source.id || ''))
                  .map((source) => (
                    <div key={source.id} className="bg-white border border-gray-200 rounded-lg p-4 hover:border-green-300 transition-colors">
                      <div className="flex justify-between items-start">
                        <div className="flex-1">
                          <h5 className="font-semibold text-gray-800">{source.name}</h5>
                          <p className="text-sm text-gray-600 mt-1">{source.description || 'No description'}</p>
                          <div className="flex items-center mt-2 text-xs text-gray-500">
                            <span className="capitalize">{source.source_type || 'file'}</span>
                            {source.file_size && (
                              <span className="ml-2">
                                {(source.file_size / 1024 / 1024).toFixed(1)} MB
                              </span>
                            )}
                          </div>
                        </div>
                        <button
                          onClick={() => setStrategyForm(prev => ({
                            ...prev,
                            knowledge_source_ids: [...prev.knowledge_source_ids, source.id || '']
                          }))}
                          className="ml-3 bg-green-100 text-green-700 px-3 py-1 rounded-md hover:bg-green-200 transition-colors text-sm"
                        >
                          Add
                        </button>
                      </div>
                    </div>
                  ))}
              </div>
            </div>
          )}
        </div>
      </div>
    );
  };

  const renderOutcomesStep = () => {
    const actionTypes = [
      { value: 'create_task', label: 'Create Task', icon: 'ï¿½' },
      { value: 'flag_chart', label: 'Flag Chart', icon: 'ðŸš©' },
      { value: 'send_message', label: 'Send Message', icon: 'ï¿½' },
      { value: 'schedule_followup', label: 'Schedule Follow-up', icon: 'ðŸ“…' }
    ];

    const conditionOptions = [
      { value: 'meets_criteria', label: 'Meets Criteria' },
      { value: 'does_not_meet_criteria', label: 'Does Not Meet Criteria' },
      { value: 'incomplete_data', label: 'Incomplete Data' }
    ];

    const addOutcomeAction = () => {
      const newAction: OutcomeAction = {
        condition: 'meets_criteria',
        action_type: 'create_task',
        details: {},
        sequence: strategyForm.outcome_actions.length + 1
      };
      
      setStrategyForm(prev => ({
        ...prev,
        outcome_actions: [...prev.outcome_actions, newAction]
      }));
    };

    const updateOutcomeAction = (index: number, field: keyof OutcomeAction, value: any) => {
      setStrategyForm(prev => ({
        ...prev,
        outcome_actions: prev.outcome_actions.map((action, i) => 
          i === index ? { ...action, [field]: value } : action
        )
      }));
    };

    const removeOutcomeAction = (index: number) => {
      setStrategyForm(prev => ({
        ...prev,
        outcome_actions: prev.outcome_actions.filter((_, i) => i !== index)
      }));
    };

    const updateActionDetails = (index: number, key: string, value: any) => {
      setStrategyForm(prev => ({
        ...prev,
        outcome_actions: prev.outcome_actions.map((action, i) => 
          i === index ? { 
            ...action, 
            details: { ...action.details, [key]: value }
          } : action
        )
      }));
    };

    const renderActionConfiguration = (action: OutcomeAction, index: number) => {
      switch (action.action_type) {
        case 'create_task':
          return (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Task Type</label>
                <select
                  value={action.details?.task_type || ''}
                  onChange={(e) => updateActionDetails(index, 'task_type', e.target.value)}
                  className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                >
                  <option value="">Select type...</option>
                  <option value="review_results">Review Results</option>
                  <option value="contact_patient">Contact Patient</option>
                  <option value="schedule_appointment">Schedule Appointment</option>
                  <option value="order_test">Order Test</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                <select
                  value={action.details?.priority || 'normal'}
                  onChange={(e) => updateActionDetails(index, 'priority', e.target.value)}
                  className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                >
                  <option value="low">Low</option>
                  <option value="normal">Normal</option>
                  <option value="high">High</option>
                  <option value="urgent">Urgent</option>
                </select>
              </div>
              <div className="md:col-span-2">
                <label className="block text-sm font-medium text-gray-700 mb-1">Task Description</label>
                <textarea
                  value={action.details?.description || ''}
                  onChange={(e) => updateActionDetails(index, 'description', e.target.value)}
                  rows={2}
                  className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                  placeholder="Describe the task to be created..."
                />
              </div>
            </div>
          );
        
        case 'flag_chart':
          return (
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Flag Type</label>
                <select
                  value={action.details?.flag_type || ''}
                  onChange={(e) => updateActionDetails(index, 'flag_type', e.target.value)}
                  className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                >
                  <option value="">Select type...</option>
                  <option value="high_risk">High Risk</option>
                  <option value="follow_up_needed">Follow-up Needed</option>
                  <option value="screening_due">Screening Due</option>
                  <option value="alert">Alert</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Flag Message</label>
                <textarea
                  value={action.details?.message || ''}
                  onChange={(e) => updateActionDetails(index, 'message', e.target.value)}
                  rows={3}
                  className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                  placeholder="Enter flag message for chart..."
                />
              </div>
            </div>
          );

        case 'send_message':
          return (
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Message Type</label>
                <select
                  value={action.details?.message_type || ''}
                  onChange={(e) => updateActionDetails(index, 'message_type', e.target.value)}
                  className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                >
                  <option value="">Select type...</option>
                  <option value="email">Email</option>
                  <option value="sms">SMS</option>
                  <option value="portal">Patient Portal</option>
                  <option value="in_app">In-App Message</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Message Template</label>
                <textarea
                  value={action.details?.message || ''}
                  onChange={(e) => updateActionDetails(index, 'message', e.target.value)}
                  rows={3}
                  className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                  placeholder="Enter message content..."
                />
              </div>
            </div>
          );

        case 'schedule_followup':
          return (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Follow-up Type</label>
                <select
                  value={action.details?.followup_type || ''}
                  onChange={(e) => updateActionDetails(index, 'followup_type', e.target.value)}
                  className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                >
                  <option value="">Select type...</option>
                  <option value="consultation">Consultation</option>
                  <option value="screening">Screening</option>
                  <option value="test_results">Test Results Review</option>
                  <option value="genetic_counseling">Genetic Counseling</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Time Frame</label>
                <select
                  value={action.details?.timeframe || ''}
                  onChange={(e) => updateActionDetails(index, 'timeframe', e.target.value)}
                  className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                >
                  <option value="">Select timeframe...</option>
                  <option value="1_week">1 Week</option>
                  <option value="2_weeks">2 Weeks</option>
                  <option value="1_month">1 Month</option>
                  <option value="3_months">3 Months</option>
                  <option value="6_months">6 Months</option>
                  <option value="1_year">1 Year</option>
                </select>
              </div>
            </div>
          );

        default:
          return (
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Configuration (JSON)</label>
              <textarea
                value={JSON.stringify(action.details || {}, null, 2)}
                onChange={(e) => {
                  try {
                    const details = JSON.parse(e.target.value);
                    updateOutcomeAction(index, 'details', details);
                  } catch (err) {
                    // Invalid JSON, ignore for now
                  }
                }}
                rows={4}
                className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm"
                placeholder="Enter JSON configuration..."
              />
            </div>
          );
      }
    };

    return (
      <div className="space-y-8">
        <div className="text-center">
          <div className="mx-auto w-16 h-16 bg-gradient-to-r from-orange-100 to-orange-200 rounded-full flex items-center justify-center mb-4">
            <svg className="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
            </svg>
          </div>
          <h3 className="text-2xl font-bold text-gray-900 mb-2">Outcome Actions</h3>
          <p className="text-gray-600 text-lg">Define what happens after patient interactions, including follow-ups and next steps.</p>
        </div>

        <div className="max-w-4xl mx-auto">
          <div className="bg-gradient-to-r from-orange-50 to-orange-100 p-6 rounded-xl border-2 border-orange-200 mb-6">
            <h4 className="text-lg font-semibold text-orange-800 mb-3">Outcome Actions</h4>
            <p className="text-orange-600 mb-4">Configure automatic actions that trigger based on conversation outcomes and patient responses.</p>
            
            {strategyForm.outcome_actions.length === 0 ? (
              <div className="text-center py-8">
                <svg className="w-12 h-12 text-orange-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 9l3 3m0 0l-3 3m3-3H8m13 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p className="text-orange-500 mb-4">No outcome actions defined yet</p>
                <button
                  onClick={addOutcomeAction}
                  className="bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700 transition-colors"
                >
                  Add First Action
                </button>
              </div>
            ) : (
              <div className="space-y-6">
                {strategyForm.outcome_actions.map((action, index) => (
                  <div key={index} className="bg-white p-6 rounded-lg border-2 border-orange-200">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Condition</label>
                        <select
                          value={action.condition}
                          onChange={(e) => updateOutcomeAction(index, 'condition', e.target.value)}
                          className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                        >
                          {conditionOptions.map(option => (
                            <option key={option.value} value={option.value}>{option.label}</option>
                          ))}
                        </select>
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Action Type</label>
                        <select
                          value={action.action_type}
                          onChange={(e) => updateOutcomeAction(index, 'action_type', e.target.value)}
                          className="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                        >
                          {actionTypes.map(option => (
                            <option key={option.value} value={option.value}>
                              {option.icon} {option.label}
                            </option>
                          ))}
                        </select>
                      </div>
                      
                      <div className="flex items-end">
                        <button
                          onClick={() => removeOutcomeAction(index)}
                          className="w-full bg-red-100 text-red-600 px-3 py-2 rounded-md hover:bg-red-200 transition-colors"
                        >
                          Remove
                        </button>
                      </div>
                    </div>
                    
                    <div className="border-t border-orange-200 pt-4">
                      <h5 className="text-sm font-medium text-gray-700 mb-3">Action Configuration</h5>
                      {renderActionConfiguration(action, index)}
                    </div>
                  </div>
                ))}
                
                <button
                  onClick={addOutcomeAction}
                  className="w-full bg-orange-100 text-orange-600 px-4 py-3 rounded-lg border-2 border-orange-200 hover:bg-orange-200 transition-colors flex items-center justify-center"
                >
                  <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                  </svg>
                  Add Another Action
                </button>
              </div>
            )}
          </div>

          <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
            <h5 className="font-semibold text-blue-800 mb-2">Example Outcome Actions:</h5>
            <ul className="text-sm text-blue-700 space-y-1">
              <li>â€¢ High Risk Identified â†’ Schedule genetic counseling appointment</li>
              <li>â€¢ Screening Recommended â†’ Send appointment booking notification</li>
              <li>â€¢ Patient Declined â†’ Log interaction and set follow-up reminder</li>
              <li>â€¢ Conversation Complete â†’ Generate patient summary report</li>
            </ul>
          </div>
        </div>
      </div>
    );
  };

  const renderWizardStep = () => {
    switch (currentStep) {
      case 'overview':
        return renderOverviewStep();
      case 'targeting':
        return renderTargetingStep();
      case 'knowledge':
        return renderKnowledgeStep();
      case 'outcomes':
        return renderOutcomesStep();
      case 'testing':
        return (
          <div className="space-y-8">
            <div className="text-center">
              <div className="mx-auto w-16 h-16 bg-gradient-to-r from-indigo-100 to-indigo-200 rounded-full flex items-center justify-center mb-4">
                <svg className="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                </svg>
              </div>
              <h3 className="text-2xl font-bold text-gray-900 mb-2">Strategy Testing</h3>
              <p className="text-gray-600 text-lg">Test your strategy with simulated patient scenarios before deployment.</p>
            </div>
            
            <div className="bg-gradient-to-r from-indigo-50 to-indigo-100 p-8 rounded-xl border-2 border-indigo-200">
              <div className="text-center mb-6">
                <svg className="w-12 h-12 text-indigo-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 012 2z" />
                </svg>
                <h4 className="text-lg font-semibold text-indigo-800 mb-2">Interactive Testing Environment</h4>
                <p className="text-indigo-600 mb-6">Run test conversations, validate responses, and fine-tune strategy performance.</p>
                
                {!testResults && (
                  <button
                    onClick={handleRunTests}
                    disabled={isTestingStrategy}
                    className="bg-gradient-to-r from-indigo-600 to-indigo-700 text-white px-8 py-3 rounded-lg hover:from-indigo-700 hover:to-indigo-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-semibold"
                  >
                    {isTestingStrategy ? 'Running Tests...' : 'Run Test Scenarios'}
                  </button>
                )}
              </div>
              
              {/* Test Scenarios */}
              <div className="space-y-4">
                {testScenarios.map((scenario) => (
                  <div key={scenario.id} className="bg-white p-4 rounded-lg border border-indigo-200 flex items-center justify-between">
                    <div className="flex items-center space-x-3">
                      <div className={`w-3 h-3 rounded-full ${
                        scenario.status === 'pending' ? 'bg-gray-300' :
                        scenario.status === 'running' ? 'bg-yellow-400 animate-pulse' :
                        scenario.status === 'passed' ? 'bg-green-400' : 'bg-red-400'
                      }`}></div>
                      <span className="font-medium text-gray-900">{scenario.name}</span>
                    </div>
                    <span className={`px-3 py-1 rounded-full text-xs font-medium ${
                      scenario.status === 'pending' ? 'bg-gray-100 text-gray-600' :
                      scenario.status === 'running' ? 'bg-yellow-100 text-yellow-800' :
                      scenario.status === 'passed' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                    }`}>
                      {scenario.status.charAt(0).toUpperCase() + scenario.status.slice(1)}
                    </span>
                  </div>
                ))}
              </div>
              
              {/* Test Results */}
              {testResults && (
                <div className="mt-6 p-4 bg-white rounded-lg border border-indigo-200">
                  <div className="flex items-center space-x-3 mb-2">
                    <svg className={`w-6 h-6 ${testResults.status === 'passed' ? 'text-green-500' : 'text-red-500'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={testResults.status === 'passed' ? "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" : "M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"} />
                    </svg>
                    <h5 className="text-lg font-semibold text-gray-900">Test Results</h5>
                  </div>
                  <p className={`font-medium ${testResults.status === 'passed' ? 'text-green-700' : 'text-red-700'}`}>
                    {testResults.status === 'passed' 
                      ? `All ${testResults.passedScenarios}/${testResults.totalScenarios} test scenarios passed successfully!`
                      : `Test failed: ${testResults.error}`
                    }
                  </p>
                  <p className="text-sm text-gray-500 mt-1">
                    Completed at {testResults.completedAt.toLocaleTimeString()}
                  </p>
                </div>
              )}
            </div>
          </div>
        );
      case 'review':
        return (
          <div className="space-y-8">
            <div className="text-center">
              <div className="mx-auto w-16 h-16 bg-gradient-to-r from-emerald-100 to-emerald-200 rounded-full flex items-center justify-center mb-4">
                <svg className="w-8 h-8 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <h3 className="text-2xl font-bold text-gray-900 mb-2">Review & Deploy</h3>
              <p className="text-gray-600 text-lg">Review your complete configuration and deploy the strategy to start screening patients.</p>
            </div>
            
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <div className="bg-gradient-to-r from-blue-50 to-blue-100 p-6 rounded-xl border-2 border-blue-200">
                <div className="flex items-center mb-4">
                  <svg className="w-6 h-6 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  <h4 className="text-lg font-bold text-blue-900">Strategy Summary</h4>
                </div>
                <div className="space-y-3 text-sm">
                  <div className="flex justify-between">
                    <span className="font-medium text-blue-800">Name:</span>
                    <span className="text-blue-700">{strategyForm.name || 'Untitled Strategy'}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="font-medium text-blue-800">Specialty:</span>
                    <span className="text-blue-700">{strategyForm.specialty}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="font-medium text-blue-800">Status:</span>
                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                      strategyForm.is_active 
                        ? 'bg-green-200 text-green-800' 
                        : 'bg-yellow-200 text-yellow-800'
                    }`}>
                      {strategyForm.is_active ? 'Will be activated' : 'Will be created as draft'}
                    </span>
                  </div>
                </div>
              </div>
              
              <div className="bg-gradient-to-r from-emerald-50 to-emerald-100 p-6 rounded-xl border-2 border-emerald-200">
                <div className="flex items-center mb-4">
                  <svg className="w-6 h-6 text-emerald-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                  </svg>
                  <h4 className="text-lg font-bold text-emerald-900">Ready to Deploy</h4>
                </div>
                <p className="text-emerald-700 text-sm mb-4">
                  Your strategy configuration is complete and ready for deployment. Click deploy to make it available for patient interactions.
                </p>
                <button 
                  onClick={handleDeployStrategy}
                  disabled={isDeploying}
                  className="w-full bg-gradient-to-r from-emerald-600 to-emerald-700 text-white py-3 px-4 rounded-lg hover:from-emerald-700 hover:to-emerald-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-semibold"
                >
                  {isDeploying ? 'Deploying...' : 'Deploy Strategy Now'}
                </button>
              </div>
            </div>
          </div>
        );
      default:
        return renderOverviewStep();
    }
  };

  return (
    <div className="max-w-7xl mx-auto p-6">
      <div className="bg-white rounded-xl shadow-lg border border-gray-200">
        {/* Navigation Header */}
        <div className="border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50 px-8 py-6 rounded-t-xl">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-3xl font-bold text-gray-900 mb-2">AI Chat Configuration</h1>
              <p className="text-gray-600 text-lg">Configure intelligent patient screening workflows with advanced targeting and outcome management.</p>
            </div>
            {activeView === 'dashboard' && (
              <button
                onClick={handleCreateNewStrategy}
                className="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-8 py-4 rounded-xl hover:from-blue-700 hover:to-blue-800 flex items-center space-x-3 shadow-lg transform hover:scale-105 transition-all duration-200"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
                <span className="font-semibold">Create New Strategy</span>
              </button>
            )}
          </div>
        </div>

        {/* Tab Navigation */}
        <div className="border-b border-gray-200 bg-gray-50">
          <nav className="flex space-x-1 px-8">
            <button
              onClick={() => setActiveView('dashboard')}
              className={`py-4 px-6 border-b-3 font-semibold text-sm transition-all duration-200 flex items-center space-x-2 ${
                activeView === 'dashboard'
                  ? 'border-blue-500 text-blue-600 bg-white'
                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-100'
              }`}
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              <span>Strategy Dashboard</span>
            </button>              <button
                onClick={() => setActiveView('wizard')}
                className={`py-4 px-6 border-b-3 font-semibold text-sm transition-all duration-200 flex items-center space-x-2 ${
                  activeView === 'wizard'
                    ? 'border-blue-500 text-blue-600 bg-white'
                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-100'
                }`}
              >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
              <span>{editingStrategy ? `Edit Strategy: ${editingStrategy.name}` : 'Configuration Wizard'}</span>
            </button>
            <button
              onClick={() => setActiveView('analytics')}
              className={`py-4 px-6 border-b-3 font-semibold text-sm transition-all duration-200 flex items-center space-x-2 ${
                activeView === 'analytics'
                  ? 'border-blue-500 text-blue-600 bg-white'
                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-100'
              }`}
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              <span>Analytics</span>
            </button>
          </nav>
        </div>

        {/* Content Area */}
        <div className="p-8">
          {activeView === 'dashboard' && (
            <>
              {loading ? (
                <div className="text-center py-16">
                  <div className="mx-auto w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-4 animate-pulse">
                    <svg className="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                  </div>
                  <p className="text-gray-600">Loading strategies...</p>
                </div>
              ) : error ? (
                <div className="text-center py-16">
                  <div className="mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4">
                    <svg className="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  </div>
                  <h3 className="text-xl font-bold text-gray-900 mb-2">Error Loading Strategies</h3>
                  <p className="text-gray-600 mb-4">{error}</p>
                  <button
                    onClick={loadStrategies}
                    className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                  >
                    Retry
                  </button>
                </div>
              ) : strategies.length === 0 ? (
                <div className="text-center py-16">
                  <div className="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-6">
                    <svg className="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" />
                    </svg>
                  </div>
                  <h3 className="text-2xl font-bold text-gray-900 mb-4">No Strategies Yet</h3>
                  <p className="text-gray-600 text-lg mb-8 max-w-md mx-auto">Get started by creating your first AI chat strategy to begin screening patients.</p>
                  <button
                    onClick={handleCreateNewStrategy}
                    className="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-8 py-4 rounded-xl hover:from-blue-700 hover:to-blue-800 flex items-center space-x-3 shadow-lg transform hover:scale-105 transition-all duration-200 mx-auto"
                  >
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    <span className="font-semibold">Create Your First Strategy</span>
                  </button>
                </div>
              ) : (
                <div className="space-y-6">
                  {/* Strategy List Header */}
                  <div className="flex items-center justify-between">
                    <div>
                      <h2 className="text-2xl font-bold text-gray-900">Your Strategies</h2>
                      <p className="text-gray-600">Manage and monitor your AI chat strategies ({filteredStrategies.length} of {strategies.length})</p>
                    </div>
                    <button
                      onClick={handleCreateNewStrategy}
                      className={buttonStyles.primary}
                    >
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                      </svg>
                      <span>New Strategy</span>
                    </button>
                  </div>

                  {/* Filters and Search */}
                  <div className="bg-gray-50 p-6 rounded-xl border border-gray-200">
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                      {/* Search */}
                      <div className="md:col-span-2">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Search Strategies</label>
                        <div className="relative">
                          <input
                            type="text"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            placeholder="Search by name, description, or specialty..."
                            className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          />
                          <svg className="absolute left-3 top-2.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                          </svg>
                        </div>
                      </div>

                      {/* Status Filter */}
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select
                          value={statusFilter}
                          onChange={(e) => setStatusFilter(e.target.value as 'all' | 'active' | 'draft')}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                          <option value="all">All Status</option>
                          <option value="active">Active</option>
                          <option value="draft">Draft</option>
                        </select>
                      </div>

                      {/* Specialty Filter */}
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Specialty</label>
                        <select
                          value={specialtyFilter}
                          onChange={(e) => setSpecialtyFilter(e.target.value)}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                          <option value="all">All Specialties</option>
                          {uniqueSpecialties.map(specialty => (
                            <option key={specialty} value={specialty}>{specialty}</option>
                          ))}
                        </select>
                      </div>
                    </div>

                    {/* Clear Filters */}
                    {(searchTerm || statusFilter !== 'all' || specialtyFilter !== 'all') && (
                      <div className="mt-4 flex items-center justify-between">
                        <span className="text-sm text-gray-600">
                          Showing {filteredStrategies.length} of {strategies.length} strategies
                        </span>
                        <button
                          onClick={() => {
                            setSearchTerm('');
                            setStatusFilter('all');
                            setSpecialtyFilter('all');
                          }}
                          className="text-sm text-blue-600 hover:text-blue-800 font-medium"
                        >
                          Clear Filters
                        </button>
                      </div>
                    )}
                  </div>

                  {/* Strategy Grid */}
                  {filteredStrategies.length === 0 ? (
                    <div className="text-center py-12">
                      <svg className="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                      </svg>
                      <h3 className="text-lg font-medium text-gray-900 mb-2">No strategies found</h3>
                      <p className="text-gray-500 mb-4">Try adjusting your search or filter criteria</p>
                      <button
                        onClick={() => {
                          setSearchTerm('');
                          setStatusFilter('all');
                          setSpecialtyFilter('all');
                        }}
                        className="text-blue-600 hover:text-blue-800 font-medium"
                      >
                        Clear all filters
                      </button>
                    </div>
                  ) : (
                    <>
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {paginatedStrategies.map((strategy) => (
                      <div key={strategy.id} className="bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition-shadow duration-200">
                        <div className="p-6">
                          <div className="flex items-start justify-between mb-4">
                            <div className="flex-1">
                              <h3 className="text-lg font-semibold text-gray-900 mb-1">{strategy.name}</h3>
                              <p className="text-sm text-gray-600 line-clamp-2">{strategy.description}</p>
                            </div>
                            <div className="flex items-center space-x-3">
                              <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                (strategy.is_active || false)
                                  ? 'bg-green-100 text-green-800' 
                                  : 'bg-gray-100 text-gray-600'
                              }`}>
                                {(strategy.is_active || false) ? 'Active' : 'Draft'}
                              </span>
                              {/* Toggle Switch */}
                              <label className="relative inline-flex items-center cursor-pointer">
                                <input
                                  type="checkbox"
                                  checked={strategy.is_active || false}
                                  onChange={() => handleToggleStrategy(strategy.id!, strategy.is_active || false)}
                                  className="sr-only peer"
                                />
                                <div className={`relative w-11 h-6 rounded-full peer transition-colors duration-200 ease-in-out ${
                                  (strategy.is_active || false)
                                    ? 'bg-green-600' 
                                    : 'bg-gray-200'
                                } peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 dark:peer-focus:ring-green-800`}>
                                  <div className={`absolute top-[2px] left-[2px] bg-white border border-gray-300 rounded-full h-5 w-5 transition-transform duration-200 ease-in-out ${
                                    (strategy.is_active || false) ? 'translate-x-5' : 'translate-x-0'
                                  }`}></div>
                                </div>
                                <span className="ml-2 text-sm text-gray-600">
                                  {(strategy.is_active || false) ? 'Active' : 'Inactive'}
                                </span>
                              </label>
                            </div>
                          </div>
                          
                          <div className="space-y-2 mb-4">
                            <div className="flex items-center text-sm text-gray-500">
                              <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" />
                              </svg>
                              <span>{strategy.specialty || 'General'}</span>
                            </div>
                            <div className="flex items-center text-sm text-gray-500">
                              <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />
                              </svg>
                              <span>{strategy.knowledge_sources?.length || 0} Knowledge Sources</span>
                            </div>
                            <div className="flex items-center text-sm text-gray-500">
                              <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                              </svg>
                              <span>{strategy.targeting_rules?.length || 0} Targeting Rules</span>
                            </div>
                          </div>

                          <div className="flex items-center justify-between pt-4 border-t border-gray-100">
                            <div className="text-xs text-gray-400">
                              {strategy.updated_at && `Updated ${new Date(strategy.updated_at).toLocaleDateString()}`}
                            </div>
                            <div className="flex items-center space-x-2">
                              <button 
                                onClick={() => handleEditStrategy(strategy)}
                                className="text-blue-600 hover:text-blue-800 text-sm font-medium"
                              >
                                Edit
                              </button>
                              <button 
                                onClick={() => handleDeleteStrategy(strategy.id!)}
                                className="text-red-600 hover:text-red-800 text-sm font-medium"
                              >
                                Delete
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>

                  {/* Pagination */}
                  {totalPages > 1 && (
                    <div className="flex items-center justify-between">
                      <div className="text-sm text-gray-700">
                        Showing {startIndex + 1} to {Math.min(startIndex + itemsPerPage, filteredStrategies.length)} of {filteredStrategies.length} strategies
                      </div>
                      <div className="flex items-center space-x-2">
                        <button
                          onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
                          disabled={currentPage === 1}
                          className={buttonStyles.pagination}
                        >
                          Previous
                        </button>
                        
                        <div className="flex items-center space-x-1">
                          {Array.from({ length: totalPages }, (_, i) => i + 1).map(page => (
                            <button
                              key={page}
                              onClick={() => setCurrentPage(page)}
                              className={`px-3 py-2 text-sm font-medium rounded-md ${
                                currentPage === page
                                  ? 'bg-blue-600 text-white'
                                  : 'text-gray-500 bg-white border border-gray-300 hover:bg-gray-50'
                              }`}
                            >
                              {page}
                            </button>
                          ))}
                        </div>

                        <button
                          onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
                          disabled={currentPage === totalPages}
                          className={buttonStyles.pagination}
                        >
                          Next
                        </button>
                      </div>
                    </div>
                  )}
                    </>
                  )}
                </div>
              )}
            </>
          )}
          
          {activeView === 'wizard' && (
            <div>
              {/* Step Progress */}
              <div className="mb-12">
                <div className="flex items-center justify-between">
                  {steps.map((step, index) => (
                    <div key={step.id} className="flex items-center group">
                      <div className="flex flex-col items-center">
                        <button
                          onClick={() => {
                            if (canNavigateToStep(step.id as ConfigurationStep)) {
                              setCurrentStep(step.id as ConfigurationStep);
                            }
                          }}
                          disabled={!canNavigateToStep(step.id as ConfigurationStep)}
                          className={`flex items-center justify-center w-12 h-12 rounded-full text-sm font-bold shadow-lg transition-all duration-300 ${
                            step.id === currentStep
                              ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white ring-4 ring-blue-100'
                              : steps.findIndex(s => s.id === currentStep) > index || isStepComplete(step.id as ConfigurationStep)
                              ? 'bg-gradient-to-r from-green-500 to-green-600 text-white hover:from-green-600 hover:to-green-700'
                              : canNavigateToStep(step.id as ConfigurationStep)
                              ? 'bg-gray-200 text-gray-600 hover:bg-gray-300 cursor-pointer'
                              : 'bg-gray-200 text-gray-400 cursor-not-allowed opacity-50'
                          }`}
                        >
                          {steps.findIndex(s => s.id === currentStep) > index || isStepComplete(step.id as ConfigurationStep) ? (
                            <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                              <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                            </svg>
                          ) : (
                            index + 1
                          )}
                        </button>
                        <div className="mt-4 text-center">
                          <div className={`text-sm font-bold ${
                            step.id === currentStep ? 'text-blue-600' : 
                            canNavigateToStep(step.id as ConfigurationStep) ? 'text-gray-600' : 'text-gray-400'
                          }`}>
                            {step.name}
                          </div>
                          <div className="text-xs text-gray-500 mt-1">{step.description}</div>
                          {isStepComplete(step.id as ConfigurationStep) && step.id !== currentStep && (
                            <div className="text-xs text-green-600 font-medium mt-1">âœ“ Complete</div>
                          )}
                        </div>
                      </div>
                      {index < steps.length - 1 && (
                        <div className={`flex-1 mx-6 h-1 rounded-full transition-all duration-300 ${
                          steps.findIndex(s => s.id === currentStep) > index || isStepComplete(step.id as ConfigurationStep)
                            ? 'bg-gradient-to-r from-green-400 to-green-500'
                            : 'bg-gray-200'
                        }`}></div>
                      )}
                    </div>
                  ))}
                </div>
              </div>

              {/* Step Content */}
              <div className="bg-white rounded-xl border border-gray-200 shadow-sm">
                <div className="p-8">
                  {renderWizardStep()}
                </div>
              </div>


              {/* Navigation Buttons */}
              <div className="mt-8 flex justify-between">
                <button
                  onClick={() => {
                    const currentIndex = steps.findIndex(s => s.id === currentStep);
                    if (currentIndex > 0) {
                      setCurrentStep(steps[currentIndex - 1].id as ConfigurationStep);
                    }
                  }}
                  disabled={currentStep === 'overview'}
                  className={buttonStyles.secondary}
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                  </svg>
                  <span>Previous</span>
                </button>
                
                <button
                  onClick={() => {
                    if (currentStep === 'review') {
                      handleDeployStrategy();
                    } else {
                      const currentIndex = steps.findIndex(s => s.id === currentStep);
                      if (currentIndex < steps.length - 1) {
                        const nextStep = steps[currentIndex + 1].id as ConfigurationStep;
                        if (canNavigateToStep(nextStep)) {
                          setCurrentStep(nextStep);
                        }
                      }
                    }
                  }}
                  disabled={
                    currentStep === 'review' ? isDeploying : 
                    !isStepComplete(currentStep) || 
                    (() => {
                      const currentIndex = steps.findIndex(s => s.id === currentStep);
                      const nextStep = steps[currentIndex + 1];
                      return nextStep && !canNavigateToStep(nextStep.id as ConfigurationStep);
                    })()
                  }
                  className={buttonStyles.primary}
                >
                  <span>
                    {currentStep === 'review' 
                      ? (isDeploying ? 'Deploying...' : 'Deploy Strategy') 
                      : (isStepComplete(currentStep) ? 'Next' : 'Complete This Step')
                    }
                  </span>
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                  </svg>
                </button>
              </div>
            </div>
          )}
          
          {activeView === 'analytics' && (
            <div className="space-y-8">
              <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                {/* Key Metrics Cards */}
                <div className="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-6 text-white">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-blue-100 text-sm font-medium">Total Strategies</p>
                      <p className="text-3xl font-bold">{strategies.length}</p>
                    </div>
                    <div className="bg-blue-400 bg-opacity-50 rounded-lg p-3">
                      <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 012 2h2a2 2 0 002-2z" />
                      </svg>
                    </div>
                  </div>
                </div>

                <div className="bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-6 text-white">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-green-100 text-sm font-medium">Active Strategies</p>
                      <p className="text-3xl font-bold">{strategies.filter(s => s.is_active).length}</p>
                    </div>
                    <div className="bg-green-400 bg-opacity-50 rounded-lg p-3">
                      <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </div>
                  </div>
                </div>

                <div className="bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl p-6 text-white">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-purple-100 text-sm font-medium">Knowledge Sources</p>
                      <p className="text-3xl font-bold">{knowledgeSources.length}</p>
                    </div>
                    <div className="bg-purple-400 bg-opacity-50 rounded-lg p-3">
                      <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />
                      </svg>
                    </div>
                  </div>
                </div>

                <div className="bg-gradient-to-r from-orange-500 to-orange-600 rounded-xl p-6 text-white">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-orange-100 text-sm font-medium">Avg. Success Rate</p>
                      <p className="text-3xl font-bold">87%</p>
                    </div>
                    <div className="bg-orange-400 bg-opacity-50 rounded-lg p-3">
                      <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                      </svg>
                    </div>
                  </div>
                </div>
              </div>

              {/* Performance Charts */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div className="bg-white rounded-xl border-2 border-gray-200 p-6">
                  <h4 className="text-lg font-semibold text-gray-900 mb-4">Strategy Performance</h4>
                  <div className="h-64 flex items-center justify-center bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                    <div className="text-center">
                      <svg className="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                      </svg>
                      <p className="text-gray-500">Chart visualization</p>
                      <p className="text-sm text-gray-400">Performance data over time</p>
                    </div>
                  </div>
                </div>

                <div className="bg-white rounded-xl border-2 border-gray-200 p-6">
                  <h4 className="text-lg font-semibold text-gray-900 mb-4">Patient Engagement</h4>
                  <div className="h-64 flex items-center justify-center bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                    <div className="text-center">
                      <svg className="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
                      </svg>
                      <p className="text-gray-500">Pie chart visualization</p>
                      <p className="text-sm text-gray-400">Engagement breakdown</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* Recent Activity */}
              <div className="bg-white rounded-xl border-2 border-gray-200 p-6">
                <h4 className="text-lg font-semibold text-gray-900 mb-4">Recent Strategy Activity</h4>
                <div className="space-y-4">
                  {strategies.slice(0, 5).map((strategy, index) => (
                    <div key={strategy.id} className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                      <div className="flex items-center">
                        <div className="w-10 h-10 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-sm mr-4">
                          {strategy.name.charAt(0)}
                        </div>
                        <div>
                          <h5 className="font-medium text-gray-900">{strategy.name}</h5>
                          <p className="text-sm text-gray-500">{strategy.specialty}</p>
                        </div>
                      </div>
                      <div className="text-right">
                        <div className="flex items-center text-sm text-gray-500">
                          <span className={`inline-block w-2 h-2 rounded-full mr-2 ${
                            strategy.is_active ? 'bg-green-400' : 'bg-gray-400'
                          }`}></span>
                          {strategy.is_active ? 'Active' : 'Inactive'}
                        </div>
                        <p className="text-sm text-gray-400">
                          {strategy.created_at ? new Date(strategy.created_at).toLocaleDateString() : 'Recently created'}
                        </p>
                      </div>
                    </div>
                  ))}
                  
                  {strategies.length === 0 && (
                    <div className="text-center py-8">
                      <svg className="w-12 h-12 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2m-6 9l2 2 4-4" />
                      </svg>
                      <p className="text-gray-500 mb-2">No strategies created yet</p>
                      <button
                        onClick={() => setActiveView('wizard')}
                        className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                      >
                        Create Your First Strategy
                      </button>
                    </div>
                  )}
                </div>
              </div>

              {/* Strategy Performance Table */}
              <div className="bg-white rounded-xl border-2 border-gray-200 p-6">
                <h4 className="text-lg font-semibold text-gray-900 mb-4">Strategy Performance Details</h4>
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead>
                      <tr className="border-b border-gray-200">
                        <th className="text-left py-3 px-4 font-semibold text-gray-700">Strategy</th>
                        <th className="text-left py-3 px-4 font-semibold text-gray-700">Specialty</th>
                        <th className="text-left py-3 px-4 font-semibold text-gray-700">Interactions</th>
                        <th className="text-left py-3 px-4 font-semibold text-gray-700">Success Rate</th>
                        <th className="text-left py-3 px-4 font-semibold text-gray-700">Last Used</th>
                        <th className="text-left py-3 px-4 font-semibold text-gray-700">Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      {strategies.map((strategy, index) => (
                        <tr key={strategy.id} className="border-b border-gray-100 hover:bg-gray-50">
                          <td className="py-3 px-4">
                            <div>
                              <p className="font-medium text-gray-900">{strategy.name}</p>
                              <p className="text-sm text-gray-500">{strategy.description}</p>
                            </div>
                          </td>
                          <td className="py-3 px-4 text-gray-700">{strategy.specialty}</td>
                          <td className="py-3 px-4 text-gray-700">{Math.floor(Math.random() * 500) + 50}</td>
                          <td className="py-3 px-4">
                            <span className="text-green-600 font-semibold">
                              {Math.floor(Math.random() * 30) + 70}%
                            </span>
                          </td>
                          <td className="py-3 px-4 text-gray-500">
                            {strategy.updated_at ? new Date(strategy.updated_at).toLocaleDateString() : 'â€”'}
                          </td>
                          <td className="py-3 px-4">
                            <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                              strategy.is_active
                                ? 'bg-green-100 text-green-800'
                                : 'bg-gray-100 text-gray-800'
                            }`}>
                              {strategy.is_active ? 'Active' : 'Inactive'}
                            </span>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                  
                  {strategies.length === 0 && (
                    <div className="text-center py-8">
                      <p className="text-gray-500">No strategy data available</p>
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default ChatConfigurationManagerNewWorkingSimple;
