#!/usr/bin/env node

/**
 * Dynamic Fly.io configuration generator
 * Generates environment-specific fly.toml files based on environment
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const DEFAULT_CONFIG = {
  development: {
    appName: 'genascope-frontend-dev',
    backendUrl: 'https://genascope-backend.fly.dev/',
    memory: '1gb',
    cpus: 1,
    minMachines: 0,
    autoStop: 'stop'
  },
  staging: {
    appName: 'genascope-frontend-staging',
    backendUrl: 'https://genascope-backend-staging.fly.dev',
    memory: '1gb',
    cpus: 1,
    minMachines: 0,
    autoStop: 'suspend'
  },
  production: {
    appName: 'genascope-frontend',
    backendUrl: 'https://genascope-backend.fly.dev',
    memory: '2gb',
    cpus: 2,
    minMachines: 1,
    autoStop: 'suspend'
  }
};

function generateFlyConfig(environment = 'development') {
  const config = DEFAULT_CONFIG[environment];
  
  if (!config) {
    console.error(`‚ùå Unknown environment: ${environment}`);
    console.log('Available environments:', Object.keys(DEFAULT_CONFIG).join(', '));
    process.exit(1);
  }

  // Use environment variable if provided, otherwise use default
  const backendUrl = process.env.PUBLIC_API_URL || config.backendUrl;

  const flyToml = `# fly.toml - Generated for ${environment} environment
# DO NOT EDIT MANUALLY - This file is generated by scripts/generate-fly-config.js

app = '${config.appName}'
primary_region = 'den'

[build]

[env]
  HOST = "0.0.0.0"
  PUBLIC_API_URL = "${backendUrl}"
  NODE_ENV = "${environment}"

[http_service]
  internal_port = 4321
  force_https = true
  auto_stop_machines = '${config.autoStop}'
  auto_start_machines = true
  min_machines_running = ${config.minMachines}
  processes = ['app']

[[vm]]
  memory = '${config.memory}'
  cpu_kind = 'shared'
  cpus = ${config.cpus}
`;

  // Write to fly.toml (current environment config)
  fs.writeFileSync('fly.toml', flyToml);
  
  // Also create environment-specific backup
  const envConfigFile = `fly.${environment}.toml`;
  fs.writeFileSync(envConfigFile, flyToml);
  
  console.log(`‚úÖ Generated fly.toml for ${environment} environment`);
  console.log(`üîó Backend URL: ${backendUrl}`);
  console.log(`üíæ App Name: ${config.appName}`);
  console.log(`üì± Resources: ${config.memory}, ${config.cpus} CPU(s)`);
  
  if (process.env.CI) {
    console.log(`::notice::Generated Fly.io config for ${environment} environment`);
  }
}

// Get environment from command line argument or environment variable
const environment = process.argv[2] || process.env.NODE_ENV || process.env.DEPLOYMENT_ENV || 'development';

try {
  generateFlyConfig(environment);
} catch (error) {
  console.error('‚ùå Error generating Fly.io configuration:', error.message);
  process.exit(1);
}
